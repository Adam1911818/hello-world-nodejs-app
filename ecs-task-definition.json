const { ECSClient, RegisterTaskDefinitionCommand, UpdateServiceCommand } = require("@aws-sdk/client-ecs");
const fs = require('fs');

// Load the task definition from the JSON file
const taskDefinition = JSON.parse(fs.readFileSync('ecstaskdefinition.json', 'utf8'));

const ecsClient = new ECSClient();

const registerTaskDefinition = async () => {
  try {
    const registerTaskCommand = new RegisterTaskDefinitionCommand(taskDefinition);
    const response = await ecsClient.send(registerTaskCommand);
    console.log("Task definition registered:", response.taskDefinition);

    const updateServiceCommand = new UpdateServiceCommand({
      cluster: "hello-world-cluster", 
      service: "hello-world-app",
      taskDefinition: response.taskDefinition.taskDefinitionArn
    });

    const updateServiceResponse = await ecsClient.send(updateServiceCommand);
    console.log("Service updated:", updateServiceResponse);
  } catch (error) {
    console.error("Error:", error);
  }
};

registerTaskDefinition();
